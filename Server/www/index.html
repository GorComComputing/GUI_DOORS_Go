<!DOCTYPE html>
<html lang="ru">
<head>
    	<meta charset="utf-8">
    	<meta name="viewport" content="width=device-width, initial-scale=1.0">
    	<title>DOORS</title>
    	
<!-- JS -->     		
    <!-- Wasm -->
    <!--script src="/scripts/wasm/wasm_exec.js"></script-->
    <script src="/scripts/wasm/wasm_exec_tinygo.js"></script>
    <script src="/scripts/wasm/instantiateWasm.js"></script>
	
<!-- CSS -->  
	
</head>
  
<body style="overflow: hidden; margin: 0">
<canvas id="cnvs" width="1920" height="1080"></canvas>

<!-- My scripts --> 
<script>
  const go = new Go();

  const runWasm = async () => {
  const importObject = go.importObject;
  const wasmModule = await wasmBrowserInstantiate("DOORS.wasm", importObject);
  go.run(wasmModule.instance);

  // Get our exports object, with all of our exported Wasm Properties
  let exports = wasmModule.instance.exports;

  // Get our memory object from the exports
  let memory = exports.memory;

  // Create a Uint8Array to give us access to Wasm Memory
  let wasmByteMemoryArray = new Uint8Array(memory.buffer);

  // Get the pointer (index) to where our graphics buffer is located in wasm linear memory
  let graphicsBufferPointer = exports.getGraphicsBufferPointer();
  let graphicsBufferSize = exports.getGraphicsBufferSize();
  
  console.log(graphicsBufferPointer)
  console.log(graphicsBufferSize)

  let canvasElement = document.querySelector("canvas");
  let canvasContext = canvasElement.getContext("2d");
  //let canvasImageData = canvasContext.createImageData(canvasElement.width, canvasElement.height);
  
  canvasElement.onclick = function() {
  		exports.eventClick(event.offsetX, event.offsetY);
	}
	
  canvasElement.onmousedown = function() {
  		exports.eventMouseDown(event.offsetX, event.offsetY);
	}
	
  canvasElement.onmouseup = function() {
  		exports.eventMouseUp(event.offsetX, event.offsetY);
	}
	
  canvasElement.onmousemove = function() {
  		exports.eventMouseMove(event.offsetX, event.offsetY);
	}

  // Clear the canvas
  canvasContext.clearRect(0, 0, canvasElement.width, canvasElement.height);

  const draw = () => {

    //exports.eventDraw();
    
    let canvasImageData = canvasContext.createImageData(canvasElement.width, canvasElement.height);

    let imageDataArray = wasmByteMemoryArray.slice(graphicsBufferPointer, graphicsBufferPointer + graphicsBufferSize);
    canvasImageData.data.set(imageDataArray);

    canvasContext.clearRect(0, 0, canvasElement.width, canvasElement.height);
    canvasContext.putImageData(canvasImageData, 0, 0);
  };
  
   const eventKeyDown = (e) => {
   	console.log(e.key);
   	exports.eventKeyDown(e.keyCode);
   }
   
   const eventKeyUp = (e) => {
   	console.log(e.key);
   	exports.eventKeyUp(e.keyCode);
   }
   
   const resizeWindow = (e) => {
   	//console.log(e);
   	
   	
  	
  	exports.eventResizeWindow(window.innerWidth, window.innerHeight);
  	
  	graphicsBufferPointer = exports.getGraphicsBufferPointer();
  	console.log(graphicsBufferPointer);
  	graphicsBufferSize = exports.getGraphicsBufferSize();
  	console.log(graphicsBufferSize);
  	
  	canvasElement.width = window.innerWidth;
  	canvasElement.height = window.innerHeight;
  	
  	let canvasImageData = canvasContext.createImageData(canvasElement.width, canvasElement.height);
  	
  	
  	let imageDataArray = wasmByteMemoryArray.slice(graphicsBufferPointer, graphicsBufferPointer + window.innerWidth*4*window.innerWidth ); //graphicsBufferSize
    canvasImageData.data.set(imageDataArray);

    canvasContext.clearRect(0, 0, canvasElement.width, canvasElement.height);
    canvasContext.putImageData(canvasImageData, 0, 0);	
  
   	
   }

  //drawCheckerBoard();
  setInterval(() => {
    draw();
  }, 5); // 25
  
  addEventListener("keydown",  eventKeyDown);
  addEventListener("keyup",  eventKeyUp);
  addEventListener("resize", resizeWindow);
};
runWasm();
</script> 

<script src="/scripts/longpoll.js"></script>
<script src="/scripts/functions.js"></script>

</body>	
</html>

